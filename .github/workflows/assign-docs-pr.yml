# Assigns documentation PRs created by the Update Docs workflow
# to the AUTHOR (not merger) of the original PR that triggered the docs update
name: Assign Docs PR to Original Author

on:
  pull_request:
    types: [opened]

permissions:
  pull-requests: write
  contents: read

jobs:
  assign-to-original-author:
    # Only run for PRs created by github-actions bot with docs: title pattern (from Update Docs workflow)
    if: github.actor == 'github-actions[bot]' && startsWith(github.event.pull_request.title, 'docs:')
    runs-on: ubuntu-latest
    steps:
      - name: Get original PR author
        id: get_author
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "PR created by bot, finding original PR author..."

          # Get the most recently merged PR to main (within last hour to avoid race conditions)
          # This is more reliable than looking at commits, as multiple commits can stack
          PR_AUTHOR=$(gh pr list \
            --repo "${{ github.repository }}" \
            --base main \
            --state merged \
            --limit 5 \
            --json author,mergedAt \
            --jq '[.[] | select(.mergedAt != null)] | sort_by(.mergedAt) | reverse | .[0].author.login' 2>/dev/null || echo "")

          if [ -n "$PR_AUTHOR" ] && [ "$PR_AUTHOR" != "null" ]; then
            echo "Found original PR author: $PR_AUTHOR"
            echo "author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          else
            echo "No recently merged PR found, skipping assignment"
            echo "author=" >> $GITHUB_OUTPUT
          fi

      - name: Assign PR to original author
        if: steps.get_author.outputs.author != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AUTHOR="${{ steps.get_author.outputs.author }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          echo "Assigning PR #$PR_NUMBER to $AUTHOR (original PR author)"

          gh pr edit "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --add-assignee "$AUTHOR"

          echo "Successfully assigned PR #$PR_NUMBER to $AUTHOR"

      - name: Add comment with attribution
        if: steps.get_author.outputs.author != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AUTHOR="${{ steps.get_author.outputs.author }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          gh pr comment "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --body "This documentation update was triggered by changes from @$AUTHOR. Assigning for review."
