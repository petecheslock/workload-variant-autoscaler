{{- if or (eq .Values.installMode "all") (eq .Values.installMode "controller-only") }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: workload-variant-autoscaler-variantautoscaling-config
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: workload-variant-autoscaler
data:
  # Prometheus configuration - REQUIRED: Set your Prometheus server URL
  # Examples:
  # - General: "https://prometheus:9090"
  # - OpenShift: "https://thanos-querier.openshift-monitoring.svc.cluster.local:9091"
  # - KIND cluster: "https://kube-prometheus-stack-prometheus.workload-variant-autoscaler-monitoring.svc.cluster.local:9090"
  #PROMETHEUS_BASE_URL: "https://kube-prometheus-stack-prometheus.workload-variant-autoscaler-monitoring.svc.cluster.local:9090"
  PROMETHEUS_BASE_URL: {{ .Values.wva.prometheus.baseURL | quote }}

  # TLS Configuration (TLS is always enabled for HTTPS-only support)
  # PROMETHEUS_TLS_INSECURE_SKIP_VERIFY: "true"  # Skip certificate verification (development/testing only)
  PROMETHEUS_CA_CERT_PATH: {{ .Values.wva.prometheus.tls.caCertPath | default "/etc/ssl/certs/prometheus-ca.crt" | quote }}   # CA certificate for server validation
  # PROMETHEUS_CLIENT_CERT_PATH: "/path/to/client.crt"  # Client certificate for mutual TLS
  # PROMETHEUS_CLIENT_KEY_PATH: "/path/to/client.key"   # Client private key for mutual TLS
  # PROMETHEUS_SERVER_NAME: "prometheus.example.com"    # Expected server name for SNI
  PROMETHEUS_TLS_INSECURE_SKIP_VERIFY: {{ if and .Values.wva.prometheus.tls (hasKey .Values.wva.prometheus.tls "insecureSkipVerify") }}{{ .Values.wva.prometheus.tls.insecureSkipVerify | quote }}{{ else }}"true"{{ end }}
  
  # Authentication Configuration (BearerToken takes precedence over TokenPath)
  # PROMETHEUS_BEARER_TOKEN: "your-token-here"           # Direct bearer token (development/testing)
  # PROMETHEUS_TOKEN_PATH: "/path/to/token/file"        # Path to bearer token file (production with mounted secrets)
  
  # Optimization configuration
  GLOBAL_OPT_INTERVAL: {{ .Values.wva.reconcileInterval | quote }}

  # Option to scale variants to zero replicas (default: false)
  WVA_SCALE_TO_ZERO: {{ .Values.wva.scaleToZero | default "false" | quote }}

  # Option to use experimental hybrid optimization (default: false)
  EXPERIMENTAL_HYBRID_OPTIMIZATION: {{ .Values.wva.experimentalHybridOptimization | default "off" | quote }}

  # Prometheus metrics cache configuration
  # Each collector (Prometheus, EPP, etc.) has its own cache configuration
  # Enable/disable Prometheus metrics caching (default: "true") - this is for debugging purposes, can be removed in the future
  PROMETHEUS_METRICS_CACHE_ENABLED: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.enabled | default "true" | quote }}{{ else }}"true"{{ end }}
  # Prometheus cache TTL - how long metrics are cached before expiring (default: "30s")
  PROMETHEUS_METRICS_CACHE_TTL: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.ttl | default "30s" | quote }}{{ else }}"30s"{{ end }}
  # Interval for background cleanup of expired Prometheus cache entries (default: "1m")
  PROMETHEUS_METRICS_CACHE_CLEANUP_INTERVAL: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.cleanupInterval | default "1m" | quote }}{{ else }}"1m"{{ end }}
  # Background fetch interval - how often to fetch metrics in background (default: "30s", 0 = disable)
  PROMETHEUS_METRICS_CACHE_FETCH_INTERVAL: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.fetchInterval | default "30s" | quote }}{{ else }}"30s"{{ end }}
  # Freshness thresholds - when metrics are considered fresh/stale/unavailable
  PROMETHEUS_METRICS_CACHE_FRESH_THRESHOLD: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.freshThreshold | default "1m" | quote }}{{ else }}"1m"{{ end }}
  PROMETHEUS_METRICS_CACHE_STALE_THRESHOLD: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.staleThreshold | default "2m" | quote }}{{ else }}"2m"{{ end }}
  PROMETHEUS_METRICS_CACHE_UNAVAILABLE_THRESHOLD: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.unavailableThreshold | default "5m" | quote }}{{ else }}"5m"{{ end }}

  # EPP metrics cache configuration (for future EPP collector)
  # Uncomment and configure when EPP collector is implemented - future implementation
  # EPP_METRICS_CACHE_ENABLED: "true"
  # EPP_METRICS_CACHE_TTL: "15s"
  # EPP_METRICS_CACHE_MAX_SIZE: "500"
  # EPP_METRICS_CACHE_CLEANUP_INTERVAL: "30s"
{{- end }}
